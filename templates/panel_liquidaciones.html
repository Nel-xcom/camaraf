{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control de Pagos</title>
    <link rel="stylesheet" href="{% static 'css/panel-liquidacion.css' %}">
    <link rel="shortcut icon" href="/static/images/escudo-chubut.png" />
    <script defer src="{% static 'js/panel_liquidacion.js' %}"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    {% include 'header.html' %}
    
    <div class="container">
        <div class="content-wrapper">
            <h2 class="panel-title">Panel de Control de Pagos</h2>
            
            <div class="panel-container">
                {% for obra_social, total in datos_panel.totales_por_obra.items %}
                <div class="panel-card total-obra">
                    <h3><i class="fas fa-file-invoice-dollar"></i> {{ obra_social }}</h3>
                    <p class="amount">${{ total|floatformat:2 }}</p>
                </div>
                {% endfor %}
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <h3>Comparación de Liquidaciones</h3>
                    <canvas id="comparacionLiquidaciones"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Evolución de Pagos por Mes</h3>
                    <canvas id="evolucionPagos"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // ✅ PASO 1: Convertir datos de Django en JSON SEGURO
            const comparacionLiquidaciones = {{ datos_panel.comparacion_liquidaciones|safe }};
            const evolucionPagos = {{ datos_panel.evolucion_pagos|safe }};
    
            // ✅ PASO 2: Asegurar que los datos existen antes de generar gráficos
            if (Object.keys(comparacionLiquidaciones).length === 0 || Object.keys(evolucionPagos).length === 0) {
                console.error("No hay datos suficientes para mostrar los gráficos.");
                return;
            }
    
            // ✅ PASO 3: Generar gráfico de barras para comparación de liquidaciones
            const ctx1 = document.getElementById('comparacionLiquidaciones').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(comparacionLiquidaciones),
                    datasets: [{
                        label: "Importe Liquidado",
                        data: Object.values(comparacionLiquidaciones),
                        backgroundColor: ['#2ECC71', '#FF6B6B', '#F4D03F'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
    
            // ✅ PASO 4: Generar gráfico de barras para evolución de pagos
            const ctx2 = document.getElementById('evolucionPagos').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(evolucionPagos),
                    datasets: [{
                        label: "Evolución de Pagos",
                        data: Object.values(evolucionPagos),
                        backgroundColor: '#4070B7',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
    
        });
    </script>        
    
</body>
</html>